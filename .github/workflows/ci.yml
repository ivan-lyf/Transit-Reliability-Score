name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Shared types package
  shared-types:
    name: Shared Types
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm --filter @transit/shared-types typecheck

      - name: Lint
        run: pnpm --filter @transit/shared-types lint

      - name: Build
        run: pnpm --filter @transit/shared-types build

      - name: Test
        run: pnpm --filter @transit/shared-types test

  # Config package
  config:
    name: Config Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm --filter @transit/config typecheck

      - name: Lint
        run: pnpm --filter @transit/config lint

      - name: Build
        run: pnpm --filter @transit/config build

  # API
  api:
    name: API
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Lint
        run: |
          ruff check src tests
          ruff format --check src tests

      - name: Typecheck
        run: mypy src

      - name: Test
        run: pytest --cov=transit_api --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/api/coverage.xml
          flags: api
          fail_ci_if_error: false

  # Mobile
  mobile:
    name: Mobile
    runs-on: ubuntu-latest
    needs: [shared-types]
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared-types
        run: pnpm --filter @transit/shared-types build

      - name: Typecheck
        run: pnpm --filter @transit/mobile typecheck

      - name: Lint
        run: pnpm --filter @transit/mobile lint

      - name: Test
        run: pnpm --filter @transit/mobile test

  # All checks passed
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [shared-types, config, api, mobile]
    steps:
      - name: All checks passed
        run: echo "All CI checks passed!"
